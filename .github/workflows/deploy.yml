name: Deploy to Azure

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  IMAGE_NAME: demo-app
  IMAGE_TAG: latest
  TF_WORKSPACE: dev

jobs:
# =====================================================
# DEPLOY TO DEV
# =====================================================
  deploy-dev:
    name: Deploy to DEV
    runs-on: ubuntu-latest
    environment: dev

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image
        run: |
          docker build \
            -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
            ./app

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        run: |
          az acr login --name devopsdemoacacdev2235

      - name: Push to ACR
        run: |
          docker tag ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
            devopsdemoacacdev2235.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          docker push devopsdemoacacdev2235.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Terraform Init
        working-directory: infra
        run: terraform init

      - name: Terraform Apply
        working-directory: infra
        run: terraform apply -auto-approve

      - name: Verify App Health
        run: |
          echo "‚è≥ Waiting for app to be ready..."
          sleep 15
          
          WEBAPP_URL=$(az webapp show \
            --name devops-demo-webapp-dev \
            --resource-group devops-demo-rg-dev \
            --query defaultHostName -o tsv)
          
          echo "üîç Testing health endpoint..."
          curl -f https://$WEBAPP_URL/health || exit 1
          echo "‚úÖ App is healthy!"

# =====================================================
# DEPLOY TO PROD (Optional - when ready)
# =====================================================
  deploy-prod:
    name: Deploy to PROD
    needs: deploy-dev
    runs-on: ubuntu-latest
    environment: prod
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image
        run: |
          docker build \
            -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
            ./app

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        run: |
          az acr login --name devopsdemoacacprod2235

      - name: Push to ACR
        run: |
          docker tag ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
            devopsdemoacacprod2235.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          docker push devopsdemoacacprod2235.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Terraform Init
        working-directory: infra
        env:
          TF_WORKSPACE: prod
        run: terraform init

      - name: Terraform Apply
        working-directory: infra
        env:
          TF_WORKSPACE: prod
        run: terraform apply -auto-approve

      - name: Verify App Health
        run: |
          echo "‚è≥ Waiting for app to be ready..."
          sleep 15
          
          WEBAPP_URL=$(az webapp show \
            --name devops-demo-webapp-prod \
            --resource-group devops-demo-rg-prod \
            --query defaultHostName -o tsv)
          
          echo "üîç Testing health endpoint..."
          curl -f https://$WEBAPP_URL/health || exit 1
          echo "‚úÖ App is healthy!"
