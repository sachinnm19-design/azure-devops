name: Deploy to Azure

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  IMAGE_NAME: demo-app
  IMAGE_TAG: latest

jobs:
# =====================================================
# DEPLOY TO DEV
# =====================================================
  deploy-dev:
    name: Deploy to DEV
    runs-on: ubuntu-latest
    environment: dev
    env:
      TF_WORKSPACE: dev

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Terraform Init
        working-directory: infra
        run: terraform init

      - name: Terraform Apply (Infrastructure)
        working-directory: infra
        run: terraform apply -auto-approve

      - name: Get ACR Details from Terraform
        working-directory: infra
        id: terraform
        run: |
          echo "acr_name=$(terraform output -raw acr_name)" >> $GITHUB_OUTPUT
          echo "acr_login_server=$(terraform output -raw acr_login_server)" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image
        run: |
          docker build \
            -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
            ./app

      - name: Login to ACR
        run: |
          az acr login --name ${{ steps.terraform.outputs.acr_name }}

      - name: Push to ACR
        run: |
          docker tag ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
            ${{ steps.terraform.outputs.acr_login_server }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          docker push ${{ steps.terraform.outputs.acr_login_server }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      - name: Restart Web App
        run: |
          az webapp restart \
            --name devops-demo-webapp-dev \
            --resource-group devops-demo-rg-dev

      - name: Verify App Health
        run: |
          echo "‚è≥ Waiting for app to be ready (30 seconds)..."
          sleep 30
          
          WEBAPP_URL=$(az webapp show \
            --name devops-demo-webapp-dev \
            --resource-group devops-demo-rg-dev \
            --query defaultHostName -o tsv)
          
          echo "üîç Testing health endpoint..."
          curl -f https://$WEBAPP_URL/health || exit 1
          echo "‚úÖ App is healthy!"

# =====================================================
# DEPLOY TO PROD
# =====================================================
  deploy-prod:
    name: Deploy to PROD
    needs: deploy-dev
    runs-on: ubuntu-latest
    environment: prod
    env:
      TF_WORKSPACE: prod

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Terraform Init
        working-directory: infra
        run: terraform init

      - name: Terraform Apply (Infrastructure)
        working-directory: infra
        run: terraform apply -auto-approve

      - name: Get ACR Details from Terraform
        working-directory: infra
        id: terraform
        run: |
          echo "acr_name=$(terraform output -raw acr_name)" >> $GITHUB_OUTPUT
          echo "acr_login_server=$(terraform output -raw acr_login_server)" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image
        run: |
          docker build \
            -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
            ./app

      - name: Login to ACR
        run: |
          az acr login --name ${{ steps.terraform.outputs.acr_name }}

      - name: Push to ACR
        run: |
          docker tag ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
            ${{ steps.terraform.outputs.acr_login_server }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          docker push ${{ steps.terraform.outputs.acr_login_server }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      - name: Restart Web App
        run: |
          az webapp restart \
            --name devops-demo-webapp-prod \
            --resource-group devops-demo-rg-prod

      - name: Verify App Health
        run: |
          echo "‚è≥ Waiting for app to be ready (30 seconds)..."
          sleep 30
          
          WEBAPP_URL=$(az webapp show \
            --name devops-demo-webapp-prod \
            --resource-group devops-demo-rg-prod \
            --query defaultHostName -o tsv)
          
          echo "üîç Testing health endpoint..."
          curl -f https://$WEBAPP_URL/health || exit 1
          echo "‚úÖ App is healthy!"
